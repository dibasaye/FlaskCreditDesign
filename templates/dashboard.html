{% extends "base.html" %}

{% block title %}Tableau de bord - {{ system_settings.organization_name if system_settings else 'Gestion Crédit & Épargne' }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="page-title">
                <i class="fas fa-chart-line me-2"></i>Tableau de bord - {{ system_settings.organization_name if system_settings else 'Analytics' }}
            </h1>
            <p class="text-muted">Vue d'ensemble complète avec analytics avancés</p>
        </div>
    </div>

    <!-- KPI Cards avec tendances -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-users text-primary"></i>
                </div>
                <div class="stats-content">
                    <h3 class="text-primary">{{ total_clients }}</h3>
                    <p class="text-muted mb-2">Clients Totaux</p>
                    <div class="stats-trend">
                        <span class="badge bg-light text-success border">
                            <i class="fas fa-arrow-up"></i> {{ new_clients_month }} ce mois
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-hand-holding-usd text-success"></i>
                </div>
                <div class="stats-content">
                    <h3 class="text-success">{{ active_credits }}</h3>
                    <p class="text-muted mb-2">Crédits Actifs</p>
                    <div class="stats-trend">
                        <span class="badge bg-light text-info border">
                            {{ new_credits_month }} nouveaux ce mois
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-piggy-bank text-warning"></i>
                </div>
                <div class="stats-content">
                    <h3 class="text-warning">{{ total_savings_balance|currency }}</h3>
                    <p class="text-muted mb-2">Épargne Totale</p>
                    <div class="stats-trend">
                        <span class="badge bg-light text-success border">
                            {{ total_savings }} comptes actifs
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-percentage text-info"></i>
                </div>
                <div class="stats-content">
                    <h3 class="text-info">{{ "%.1f"|format(repayment_rate) }}%</h3>
                    <p class="text-muted mb-2">Taux de Remboursement</p>
                    <div class="stats-trend">
                        {% if repayment_rate >= 70 %}
                        <span class="badge bg-light text-success border">
                            <i class="fas fa-check-circle"></i> Excellent
                        </span>
                        {% elif repayment_rate >= 50 %}
                        <span class="badge bg-light text-warning border">
                            <i class="fas fa-exclamation-triangle"></i> Moyen
                        </span>
                        {% else %}
                        <span class="badge bg-light text-danger border">
                            <i class="fas fa-times-circle"></i> À améliorer
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertes de paiement -->
    {% if upcoming_due > 0 or overdue > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Alertes de Paiement</h5>
                <div class="row">
                    {% if upcoming_due > 0 %}
                    <div class="col-md-6">
                        <p class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            <strong>{{ upcoming_due }}</strong> échéance(s) à venir dans les 7 prochains jours
                        </p>
                    </div>
                    {% endif %}
                    {% if overdue > 0 %}
                    <div class="col-md-6">
                        <p class="mb-0 text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>{{ overdue }}</strong> paiement(s) en retard
                        </p>
                    </div>
                    {% endif %}
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Graphiques Analytics Avancés -->
    <div class="row g-4 mb-4">
        <!-- Graphique de tendance mensuelle -->
        <div class="col-lg-8">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-area text-primary me-2"></i>Tendances Mensuelles (6 derniers mois)
                    </h5>
                    <canvas id="monthlyTrendChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <!-- Statuts des Crédits (Donut) -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-pie text-success me-2"></i>Répartition des Crédits
                    </h5>
                    <canvas id="creditStatusChart"></canvas>
                    <div class="mt-3">
                        <small class="text-muted">Total: {{ total_credits }} crédits</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Graphique Crédits vs Paiements -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-bar text-warning me-2"></i>Crédits vs Remboursements
                    </h5>
                    <canvas id="creditPaymentChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- KPIs Financiers détaillés -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-coins text-warning me-2"></i>Indicateurs Financiers
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="kpi-box">
                                <div class="kpi-label">Total Décaissé</div>
                                <div class="kpi-value text-primary">{{ total_credit_amount|currency }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="kpi-box">
                                <div class="kpi-label">Total Remboursé</div>
                                <div class="kpi-value text-success">{{ total_credit_paid|currency }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="kpi-box">
                                <div class="kpi-label">Solde Restant</div>
                                <div class="kpi-value text-danger">{{ (total_credit_amount - total_credit_paid)|currency }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="kpi-box">
                                <div class="kpi-label">Crédit Moyen</div>
                                <div class="kpi-value text-info">{{ avg_credit_amount|currency }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="kpi-box border-warning">
                                <div class="kpi-label">Clients à Risque</div>
                                <div class="kpi-value text-warning">
                                    <i class="fas fa-exclamation-triangle"></i> {{ risk_clients }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="kpi-box">
                                <div class="kpi-label">Épargne Moyenne</div>
                                <div class="kpi-value text-purple">{{ avg_savings_balance|currency }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Listes des activités récentes -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2 text-primary"></i>Crédits Récents
                    </h5>
                    <a href="{{ url_for('credits') }}" class="btn btn-sm btn-outline-primary">Voir tout</a>
                </div>
                <div class="card-body">
                    {% if recent_credits %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Numéro</th>
                                    <th>Client</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for credit in recent_credits %}
                                <tr>
                                    <td><a href="{{ url_for('credit_detail', id=credit.id) }}" class="text-decoration-none">{{ credit.credit_number }}</a></td>
                                    <td>{{ credit.client.full_name }}</td>
                                    <td><strong>{{ credit.amount|currency }}</strong></td>
                                    <td>
                                        {% if credit.status == 'pending' %}
                                            <span class="badge bg-warning text-dark">En attente</span>
                                        {% elif credit.status == 'approved' %}
                                            <span class="badge bg-info">Approuvé</span>
                                        {% elif credit.status == 'active' %}
                                            <span class="badge bg-success">Actif</span>
                                        {% elif credit.status == 'completed' %}
                                            <span class="badge bg-secondary">Complété</span>
                                        {% elif credit.status == 'rejected' %}
                                            <span class="badge bg-danger">Rejeté</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">Aucun crédit récent</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-plus me-2 text-success"></i>Clients Récents
                    </h5>
                    <a href="{{ url_for('clients') }}" class="btn btn-sm btn-outline-success">Voir tout</a>
                </div>
                <div class="card-body">
                    {% if recent_clients %}
                    <div class="list-group list-group-flush">
                        {% for client in recent_clients %}
                        <a href="{{ url_for('client_detail', id=client.id) }}" class="list-group-item list-group-item-action px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fas fa-user-circle text-primary me-2"></i>{{ client.full_name }}
                                    </h6>
                                    <small class="text-muted">{{ client.client_id }} • {{ client.phone if client.phone else 'Pas de téléphone' }}</small>
                                </div>
                                <small class="text-muted">{{ client.created_at.strftime('%d/%m/%Y') }}</small>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">Aucun client récent</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stats-card {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 16px;
    padding: 30px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
    box-shadow: 0 4px 6px rgba(0,0,0,0.03);
}

.stats-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.08);
    border-color: #dee2e6;
}

.stats-icon {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 2.8rem;
    opacity: 0.7;
}

.stats-content h3 {
    font-size: 2.4rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    letter-spacing: -0.5px;
}

.stats-content p {
    font-size: 0.95rem;
    margin-bottom: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.2px;
}

.stats-trend .badge {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
}

.kpi-box {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
}

.kpi-box:hover {
    border-color: #dee2e6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    background: #ffffff;
}

.kpi-box.border-warning {
    border-color: #ffc107;
    background: #fff3cd;
}

.kpi-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6c757d;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.kpi-value {
    font-size: 1.5rem;
    font-weight: bold;
}

.text-purple {
    color: #8b5cf6 !important;
}

.card {
    border: 1px solid #e9ecef;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.03);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    transform: translateY(-1px);
}

.card-header {
    border-bottom: 1px solid #e9ecef;
    padding: 1.5rem;
    background: #f8f9fa;
    font-weight: 600;
    font-size: 1.1rem;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartColors = {
        primary: '#667eea',
        success: '#10b981',
        danger: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6',
        purple: '#8b5cf6'
    };

    // Graphique de tendance mensuelle (Line Chart)
    const monthlyCtx = document.getElementById('monthlyTrendChart');
    if (monthlyCtx && typeof Chart !== 'undefined') {
        const monthlyData = {{ monthly_data|tojson }};
        const monthlyLabels = {{ monthly_labels|tojson }};
        
        new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: monthlyLabels,
                datasets: [
                    {
                        label: 'Montant Crédits',
                        data: monthlyData.map(m => m.credits_amount),
                        borderColor: chartColors.primary,
                        backgroundColor: chartColors.primary + '20',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    },
                    {
                        label: 'Remboursements',
                        data: monthlyData.map(m => m.payments_amount),
                        borderColor: chartColors.success,
                        backgroundColor: chartColors.success + '20',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += new Intl.NumberFormat('fr-FR').format(context.parsed.y) + ' FCFA';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('fr-FR', { notation: 'compact' }).format(value) + ' FCFA';
                            }
                        }
                    }
                }
            }
        });
    }

    // Graphique statuts des crédits (Doughnut)
    const statusCtx = document.getElementById('creditStatusChart');
    if (statusCtx && typeof Chart !== 'undefined') {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Actifs', 'En attente', 'Approuvés', 'Complétés', 'Rejetés'],
                datasets: [{
                    data: [{{ active_credits }}, {{ pending_credits }}, {{ approved_credits }}, {{ completed_credits }}, {{ rejected_credits }}],
                    backgroundColor: [
                        chartColors.success,
                        chartColors.warning,
                        chartColors.info,
                        '#6c757d',
                        chartColors.danger
                    ],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // Graphique Comparaison (Bar Chart)
    const comparisonCtx = document.getElementById('creditPaymentChart');
    if (comparisonCtx && typeof Chart !== 'undefined') {
        new Chart(comparisonCtx, {
            type: 'bar',
            data: {
                labels: ['Total Décaissé', 'Total Remboursé', 'Solde Restant'],
                datasets: [{
                    label: 'Montants (FCFA)',
                    data: [{{ total_credit_amount }}, {{ total_credit_paid }}, {{ total_credit_amount - total_credit_paid }}],
                    backgroundColor: [
                        chartColors.primary,
                        chartColors.success,
                        chartColors.danger
                    ],
                    borderRadius: 10,
                    barThickness: 60
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('fr-FR').format(context.parsed.y) + ' FCFA';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('fr-FR', { notation: 'compact' }).format(value);
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
